\ProvidesPackage{sdiff}

\RequirePackage{pdfcomment}
\RequirePackage{color}
\RequirePackage{zref}
\RequirePackage{ulem}

\makeatletter
\let\oldlabel\label
\renewcommand{\label}[1]{\zref@wrapper@immediate{\oldlabel{#1}}}
\makeatother

\providecommand{\DIFadd}[1]{{\protect\color{blue}#1}}
\providecommand{\DIFdel}[1]{}

\newbool{DIFkeeppage}\boolfalse{DIFkeeppage}
\newbool{DIFchange}\boolfalse{DIFchange}

\providecommand{\DIFaddbegin}{\global\booltrue{DIFkeeppage}\global\booltrue{DIFchange}}
\providecommand{\DIFaddend}{\global\booltrue{DIFkeeppage}\global\boolfalse{DIFchange}}
\providecommand{\DIFdelbegin}{\global\booltrue{DIFkeeppage}\global\booltrue{DIFchange}}
\providecommand{\DIFdelend}{\global\booltrue{DIFkeeppage}\global\boolfalse{DIFchange}}
\providecommand{\DIFmodbegin}{\global\booltrue{DIFkeeppage}\global\booltrue{DIFchange}}
\providecommand{\DIFmodend}{\global\booltrue{DIFkeeppage}\global\boolfalse{DIFchange}}

\providecommand{\DIFaddFL}[1]{\DIFadd{#1}}
\providecommand{\DIFdelFL}[1]{\DIFdel{#1}}
\providecommand{\DIFaddbeginFL}{\DIFaddbegin}
\providecommand{\DIFaddendFL}{\DIFaddend}
\providecommand{\DIFdelbeginFL}{\DIFdelbegin}
\providecommand{\DIFdelendFL}{\DIFdelend}

\AtBeginShipout{
	\ifbool{DIFkeeppage}
		{\global\boolfalse{DIFkeeppage}}
		{\ifbool{DIFchange}
			{\global\boolfalse{DIFkeeppage}}
			{\global\boolfalse{DIFkeeppage}\AtBeginShipoutDiscard}
		}
}
