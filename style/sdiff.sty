\ProvidesPackage{sdiff}

\RequirePackage{pdfcomment}
\RequirePackage{color}
\RequirePackage{zref}

\makeatletter
\let\oldlabel\label
\renewcommand{\label}[1]{\zref@wrapper@immediate{\oldlabel{#1}}}
\makeatother

\newbool{DIFkeeppage}\boolfalse{DIFkeeppage}
\newbool{DIFchange}\boolfalse{DIFchange}

\providecommand{\DIFadd}[1]{{\protect\color{blue}#1}}
\providecommand{\DIFdel}[1]{{\pdfmargincomment[author = Dawniej, color = red, opacity = 0.25, hoffset = -12.5pt]{#1}} {}}

\providecommand{\DIFaddbegin}{\texorpdfstring{\global\booltrue{DIFkeeppage}\global\booltrue{DIFchange}}{}}
\providecommand{\DIFaddend}{\texorpdfstring{\global\booltrue{DIFkeeppage}\global\boolfalse{DIFchange}}{}}
\providecommand{\DIFdelbegin}{\texorpdfstring{\global\booltrue{DIFkeeppage}\global\booltrue{DIFchange}}{}}
\providecommand{\DIFdelend}{\texorpdfstring{\global\booltrue{DIFkeeppage}\global\boolfalse{DIFchange}}{}}
\providecommand{\DIFmodbegin}{\texorpdfstring{\global\booltrue{DIFkeeppage}\global\booltrue{DIFchange}}{}}
\providecommand{\DIFmodend}{\texorpdfstring{\global\booltrue{DIFkeeppage}\global\boolfalse{DIFchange}}{}}

\providecommand{\DIFaddFL}[1]{\DIFadd{#1}}
\providecommand{\DIFdelFL}[1]{\DIFdel{#1}}
\providecommand{\DIFaddbeginFL}{}
\providecommand{\DIFaddendFL}{}
\providecommand{\DIFdelbeginFL}{}
\providecommand{\DIFdelendFL}{}

\AtBeginShipout{
	\ifbool{DIFkeeppage}
		{\global\boolfalse{DIFkeeppage}}
		{\ifbool{DIFchange}
			{\global\boolfalse{DIFkeeppage}}
			{\global\boolfalse{DIFkeeppage}\AtBeginShipoutDiscard}
		}
}
